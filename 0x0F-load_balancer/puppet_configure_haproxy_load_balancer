# Installs a HAproxy load balancer and configures endpoints 

exec { 'install haproxy':
  provider => shell,
  command  => 'sudo apt-get -y update && sudo apt-get install haproxy -y', 
}

exec { 'configure settings':
  provider => shell,
  command  => 'sudo sed -i "/s/^ENABLED*/ENABLED=1" /etc/default/haproxy;
	       sudo service rsyslog restart;
	       sudo service haproxy restart',
  require  => FILE_LINE['enable udp server run in logging', 
			'enable udp server address in logging'],
			'configure frontend',
			'configure backend',
	      EXEC['install haproxy'], 
}

file_line { 'configure frontend':
    ensure  => present,
    path    => '/etc/haproxy/haproxy.conf',
    line    => '\n\tfrontend www bind 100.26.160.178:80\n  default_backend web-backend',
    match   => '^global',
    replace => true,
}

file_line { 'configure backend':
    ensure  => present,
    path    => '/etc/haproxy/haproxy.conf',
    line    => '\n\tbackend web-backend balance roundrobin mode tcp server 37807-web-01 54.152.232.208:80 check server 37807-web-02 54.84.8.157:80 check ',
    match   => '^global.*',
    replace => true,
}

file_line { 'enable udp server run in logging':
    ensure  => present,
    path    => '/etc/rsyslog.conf',
    line    => '  UDPServerRun 514',
    match   => '^#.*UDPServerRun 514.*',
    replace => true,
}

file_line { 'enable udp server address in logging':
    ensure  => present,
    path    => '/etc/rsyslog.conf',
    line    => '  UDPServerAddress 127.0.0.1',
    match   => '^#.*UDPServerAddress 127.0.0.1.*',
    replace => true,
}

